<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>L'Elixir - Gastronomie d'Excellence</title>

<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; background-color: #fafaf9; color: #1c1917; }
h1,h2,h3,.serif { font-family:'Playfair Display', serif; }
#chat-window { display: none; width: 420px; max-width: 90vw; position: fixed; bottom: 36px; right: 10px; background:white; border-radius:2.5rem; overflow:hidden; box-shadow:0 10px 25px rgba(0,0,0,0.2); z-index:50;}
#chat-history { max-height:400px; overflow-y:auto; padding:1rem; }
#chat-controls { padding:1rem; border-top:1px solid #eee; }
</style>
</head>
<body>

<!-- Chatbot Button -->
<button id="chatbot-toggle" onclick="toggleChat()" class="fixed bottom-10 right-10 w-20 h-20 bg-amber-600 text-white rounded-full shadow-2xl flex items-center justify-center z-50">
<i class="fa-solid fa-calendar-check text-3xl"></i>
</button>

<!-- Chatbot Window -->
<div id="chat-window">
  <div class="bg-stone-900 p-4 text-white flex justify-between items-center">
    <div>Concierge d'Elixir</div>
    <button onclick="toggleChat()">X</button>
  </div>
  <div id="chat-history"></div>
  <div id="chat-controls"></div>
</div>

<!-- SMS Notification -->
<div id="notification" style="display:none; position:fixed; top:10px; right:10px; background:#111; color:white; padding:1rem; border-radius:1rem; z-index:100;">
<p id="notif-text"></p>
</div>

<script>
// --- SUPABASE CONFIG ---
const supabaseUrl = 'YOUR_SUPABASE_URL';
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// --- STATE ---
let currentStep = 'GREETING';
let reservationData = { guests: 0, time: '', name: '', contact: '' };
const TIME_SLOTS = ['17:00', '18:00', '19:00', '20:00', '21:00'];

// --- CHATBOT FUNCTIONS ---
function toggleChat() {
  const win = document.getElementById('chat-window');
  win.style.display = win.style.display === 'none' ? 'block' : 'none';
  if(win.style.display==='block' && document.getElementById('chat-history').children.length===0) runBotStep();
}

function addMessage(text, sender='bot') {
  const hist = document.getElementById('chat-history');
  const div = document.createElement('div');
  div.className = sender==='user' ? 'text-right my-2' : 'text-left my-2';
  div.innerHTML = `<div style="display:inline-block; padding:0.5rem 1rem; border-radius:1rem; background:${sender==='user'?'#f59e0b':'#eee'}; color:${sender==='user'?'white':'black'}">${text}</div>`;
  hist.appendChild(div);
  hist.scrollTop = hist.scrollHeight;
}

function runBotStep() {
  const controls = document.getElementById('chat-controls');
  setTimeout(()=> {
    switch(currentStep) {
      case 'GREETING':
        addMessage("Welcome to L'Elixir! Shall we book a table?");
        controls.innerHTML = `<button onclick="handleBotAction('START')">Begin Reservation</button>`;
        break;
      case 'ASK_GUESTS':
        addMessage("How many guests shall join us?");
        controls.innerHTML = TIME_SLOTS.map(t=>`<button onclick="handleBotAction('GUESTS', ${t})">${t}</button>`).join(' ');
        break;
      case 'ASK_TIME':
        addMessage("At what time should we expect you?");
        controls.innerHTML = TIME_SLOTS.map(t=>`<button onclick="handleBotAction('TIME','${t}')">${t}</button>`).join(' ');
        break;
      case 'ASK_NAME':
        addMessage("Under what name shall we hold the reservation?");
        controls.innerHTML = `<input id="chat-input" placeholder="Full Name"><button onclick="handleBotAction('NAME')">Next</button>`;
        break;
      case 'ASK_CONTACT':
        addMessage("Finally, your email or phone for confirmation?");
        controls.innerHTML = `<input id="chat-input" placeholder="Email or Phone"><button onclick="handleBotAction('CONTACT')">Confirm</button>`;
        break;
      case 'FINISHED':
        const code = 'RST-' + Math.random().toString(36).substring(2,7).toUpperCase();
        addMessage(`Reservation Secured! Ref: ${code}`);
        controls.innerHTML = `<button onclick="toggleChat()">Close</button>`;
        saveReservation(code);
        break;
    }
  }, 300);
}

function handleBotAction(type, value) {
  const input = document.getElementById('chat-input');
  switch(type) {
    case 'START': addMessage("Booking started.",'user'); currentStep='ASK_GUESTS'; break;
    case 'GUESTS': reservationData.guests=value; addMessage(`${value} guests`,'user'); currentStep='ASK_TIME'; break;
    case 'TIME': reservationData.time=value; addMessage(value,'user'); currentStep='ASK_NAME'; break;
    case 'NAME': if(!input.value) return alert('Enter name'); reservationData.name=input.value; addMessage(input.value,'user'); currentStep='ASK_CONTACT'; break;
    case 'CONTACT': if(!input.value) return alert('Enter contact'); reservationData.contact=input.value; addMessage(input.value,'user'); currentStep='FINISHED'; break;
  }
  document.getElementById('chat-controls').innerHTML='';
  runBotStep();
}

// --- SUPABASE INSERT ---
async function saveReservation(code) {
  try {
    const { data, error } = await supabase.from('reservations').insert([{
      name: reservationData.name,
      people: reservationData.guests,
      time: reservationData.time,
      contact: reservationData.contact,
      code: code
    }]);
    if(error) throw error;
    console.log('Saved to Supabase:', data);
  } catch(err) {
    console.error('Supabase save failed:', err.message);
  }
  showSMS(code);
}

function showSMS(code) {
  const notif = document.getElementById('notification');
  document.getElementById('notif-text').innerText = `L'Elixir: Your table for ${reservationData.guests} at ${reservationData.time} is confirmed. Ref: ${code}.`;
  notif.style.display='block';
  setTimeout(()=>{ notif.style.display='none'; },5000);
}
</script>

</body>
</html>
