<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>L'Elixir - Gastronomie d'Excellence</title>

<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; background-color: #fafaf9; color: #1c1917; }
h1,h2,h3,.serif { font-family:'Playfair Display', serif; }
#chat-window { display: none; width: 420px; max-width: 90vw; position: fixed; bottom: 36px; right: 10px; background:white; border-radius:2.5rem; overflow:hidden; box-shadow:0 10px 25px rgba(0,0,0,0.2); z-index:50;}
#chat-history { max-height:400px; overflow-y:auto; padding:1rem; }
#chat-controls { padding:1rem; border-top:1px solid #eee; }
</style>
</head>
<body>

<!-- Chatbot Button -->
<button id="chatbot-toggle" onclick="toggleChat()" class="fixed bottom-10 right-10 w-20 h-20 bg-amber-600 text-white rounded-full shadow-2xl flex items-center justify-center z-50">
<i class="fa-solid fa-calendar-check text-3xl"></i>
</button>

<!-- Chatbot Window -->
<div id="chat-window">
  <div class="bg-stone-900 p-4 text-white flex justify-between items-center">
    <div>Concierge d'Elixir</div>
    <button onclick="toggleChat()">X</button>
  </div>
  <div id="chat-history"></div>
  <div id="chat-controls"></div>
</div>

<!-- SMS Notification -->
<div id="notification" style="display:none; position:fixed; top:10px; right:10px; background:#111; color:white; padding:1rem; border-radius:1rem; z-index:100;">
<p id="notif-text"></p>
</div>

<script>
// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://wznbuimfljepqokhcwju.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6bmJ1aW1mbGplcHFva2hjd2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTg4MzcsImV4cCI6MjA4NDEzNDgzN30.2pkz1sHz-4XIvi7N4OIH-F7HHdIJ9M8dphOUTIzV3OE';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// --- STATE ---
let currentStep = 'GREETING';
let reservationData = { guests: 0, time: '', name: '', contact: '' };
const TIME_SLOTS = ['17:00', '18:00', '19:00', '20:00', '21:00'];

// --- CHATBOT FUNCTIONS ---
function toggleChat() {
    const win = document.getElementById('chat-window');
    const isOpen = win.style.display !== 'none';
    win.style.display = isOpen ? 'none' : 'flex';
    if(!isOpen && document.getElementById('chat-history').children.length === 0) runBotStep();
}

function addMessage(text, sender='bot') {
    const hist = document.getElementById('chat-history');
    const div = document.createElement('div');
    div.className = `my-2 flex ${sender==='user'?'justify-end':'justify-start'}`;
    div.innerHTML = `<div class="max-w-[80%] p-4 rounded-2xl ${sender==='user'?'bg-amber-600 text-white':'bg-white text-stone-800 shadow'}">${text}</div>`;
    hist.appendChild(div);
    hist.scrollTop = hist.scrollHeight;
}

function runBotStep() {
    const controls = document.getElementById('chat-controls');
    setTimeout(()=> {
        switch(currentStep) {
            case 'GREETING':
                addMessage("Welcome to L'Elixir! Shall we book a table?");
                controls.innerHTML = `<button onclick="handleBotAction('START')" class="w-full py-3 bg-stone-900 text-white rounded-2xl font-black uppercase text-xs hover:bg-amber-600">Begin Reservation</button>`;
                break;
            case 'ASK_GUESTS':
                addMessage("How many guests shall join us?");
                controls.innerHTML = `<div class="grid grid-cols-3 gap-2">${[1,2,3,4,5,6].map(n=>`<button onclick="handleBotAction('GUESTS', ${n})" class="py-3 border border-stone-300 rounded-2xl font-bold hover:border-amber-600">${n}</button>`).join('')}</div>`;
                break;
            case 'ASK_TIME':
                addMessage("At what time should we expect you?");
                controls.innerHTML = `<div class="grid grid-cols-2 gap-2">${TIME_SLOTS.map(t=>`<button onclick="handleBotAction('TIME','${t}')" class="py-3 border border-stone-300 rounded-2xl font-bold hover:border-amber-600">${t}</button>`).join('')}</div>`;
                break;
            case 'ASK_NAME':
                addMessage("Under what name shall we hold the reservation?");
                controls.innerHTML = `<div class="flex gap-2"><input id="chat-input" type="text" placeholder="Full Name..." class="flex-grow px-4 py-3 bg-stone-50 rounded-xl outline-none"><button onclick="handleBotAction('NAME')" class="p-4 bg-stone-900 text-white rounded-xl hover:bg-amber-600"><i class="fa-solid fa-arrow-right"></i></button></div>`;
                break;
            case 'ASK_CONTACT':
                addMessage("Finally, your email or phone for confirmation?");
                controls.innerHTML = `<div class="flex gap-2"><input id="chat-input" type="text" placeholder="Email or Phone..." class="flex-grow px-4 py-3 bg-stone-50 rounded-xl outline-none"><button onclick="handleBotAction('CONTACT')" class="p-4 bg-stone-900 text-white rounded-xl hover:bg-amber-600"><i class="fa-solid fa-check"></i></button></div>`;
                break;
            case 'FINISHED':
                const code = 'RST-' + Math.random().toString(36).substring(2,7).toUpperCase();
                addMessage(`Reservation Secured!\nRef: ${code}\nWe look forward to welcoming you.`);
                controls.innerHTML = `<button onclick="toggleChat()" class="w-full py-3 bg-stone-100 text-stone-400 rounded-2xl font-black uppercase text-xs">Close</button>`;
                saveReservation(code);
                break;
        }
    }, 400);
}

function handleBotAction(type, value) {
    const input = document.getElementById('chat-input');
    switch(type) {
        case 'START':
            addMessage("Booking started.", 'user');
            currentStep = 'ASK_GUESTS';
            break;
        case 'GUESTS':
            reservationData.guests = value;
            addMessage(`${value} guests`, 'user');
            currentStep = 'ASK_TIME';
            break;
        case 'TIME':
            reservationData.time = value;
            addMessage(value, 'user');
            currentStep = 'ASK_NAME';
            break;
        case 'NAME':
            if(!input.value) return alert('Please enter your name');
            reservationData.name = input.value;
            addMessage(input.value, 'user');
            currentStep = 'ASK_CONTACT';
            break;
        case 'CONTACT':
            if(!input.value) return alert('Please enter your email or phone');
            reservationData.contact = input.value;
            addMessage(input.value, 'user');
            currentStep = 'FINISHED';
            break;
    }
    document.getElementById('chat-controls').innerHTML='';
    runBotStep();
}

// --- SAVE TO SUPABASE ---
async function saveReservation(code) {
    try {
        const { data, error } = await supabase.from('reservations').insert([{
            name: reservationData.name,
            people: reservationData.guests,
            time: reservationData.time,
            contact: reservationData.contact,
            code: code
        }]);
        if(error) throw error;
        console.log('Saved to Supabase:', data);
    } catch(err) {
        console.error('Supabase save failed:', err.message);
    }
    showSMS(code);
}

function showSMS(code) {
    const notif = document.getElementById('notification');
    document.getElementById('notif-text').innerText = `L'Elixir: Your table for ${reservationData.guests} at ${reservationData.time} is confirmed. Ref: ${code}.`;
    notif.style.display='block';
    setTimeout(()=>{ notif.style.display='none'; },5000);
}
</script>


</body>
</html>
